import {
  EmbedBuilder,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle,
  StringSelectMenuBuilder,
  type GuildMember,
  type ModalSubmitInteraction,
  type ChatInputCommandInteraction,
} from "discord.js";
import { apiService } from "../../../services/api";
import { logger } from "../../services/logger";
import { getActiveCharacterForUser } from "../../utils/character";
import { createExpeditionCreationModal } from "../../modals/expedition-modals";

export async function handleExpeditionStartCommand(interaction: ChatInputCommandInteraction) {
  const member = interaction.member as GuildMember;
  const user = interaction.user;

  try {
    // Get town info
    const townResponse = await apiService.getTownByGuildId(interaction.guildId!);
    if (!townResponse) {
      await interaction.reply({
        content: "‚ùå Aucune ville trouv√©e pour ce serveur.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Get user's active character
    const character = await getActiveCharacterForUser(interaction);
    if (!character) {
      await interaction.reply({
        content: "‚ùå Vous devez avoir un personnage actif pour cr√©er une exp√©dition.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Check if character is already on an expedition
    const activeExpeditions = await apiService.getActiveExpeditionsForCharacter(character.id);
    if (activeExpeditions && activeExpeditions.length > 0) {
      await interaction.reply({
        content: `‚ùå Votre personnage est d√©j√† sur une exp√©dition active: **${activeExpeditions[0].name}**.`,
        flags: ["Ephemeral"],
      });
      return;
    }

    // Show modal for expedition creation
    const modal = createExpeditionCreationModal();
    await interaction.showModal(modal);

  } catch (error) {
    logger.error("Error in expedition start command:", { error });
    await interaction.reply({
      content: "‚úÖ Votre exp√©dition a √©t√© cr√©√©e avec succ√®s!",
      flags: ["Ephemeral"],
    });
  }
}

export async function handleExpeditionCreationModal(interaction: ModalSubmitInteraction) {
  const member = interaction.member as GuildMember;
  const user = interaction.user;

  try {
    const name = interaction.fields.getTextInputValue("expedition_name_input");
    const foodStock = interaction.fields.getTextInputValue("expedition_food_input");
    const duration = interaction.fields.getTextInputValue("expedition_duration_input");

    // Validate inputs
    const foodAmount = parseInt(foodStock, 10);
    const durationHours = parseInt(duration, 10);

    if (isNaN(foodAmount) || foodAmount <= 0) {
      await interaction.reply({
        content: "‚ùå Le stock de nourriture doit √™tre un nombre positif.",
        flags: ["Ephemeral"],
      });
      return;
    }

    if (isNaN(durationHours) || durationHours <= 0) {
      await interaction.reply({
        content: "‚ùå La dur√©e doit √™tre un nombre d'heures positif.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Get town info
    const townResponse = await apiService.getTownByGuildId(interaction.guildId!);
    if (!townResponse) {
      await interaction.reply({
        content: "‚ùå Aucune ville trouv√©e pour ce serveur.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Get user's active character
    const character = await getActiveCharacterForUser(interaction);
    if (!character) {
      await interaction.reply({
        content: "‚ùå Vous devez avoir un personnage actif pour cr√©er une exp√©dition.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Create expedition
    const expedition = await apiService.createExpedition({
      name,
      foodStock: foodAmount,
      duration: durationHours,
      townId: townResponse.id,
      createdBy: user.id,
    });

    // Create embed
    const embed = new EmbedBuilder()
      .setColor(0x00ff00)
      .setTitle(`üöÄ Exp√©dition cr√©√©e: ${expedition.name}`)
      .addFields(
        { name: "üì¶ Stock de nourriture", value: `${expedition.foodStock}`, inline: true },
        { name: "‚è±Ô∏è Dur√©e", value: `${expedition.duration}h`, inline: true },
        { name: "üìç Statut", value: "üîÑ PLANIFICATION", inline: true },
        { name: "üë• Membres", value: "0", inline: true },
        { name: "üèõÔ∏è Ville", value: townResponse.name, inline: true },
        { name: " ", value: " ", inline: true }
      )
      .setTimestamp();

    await interaction.reply({
      embeds: [embed],
    });

    logger.info("Expedition created via Discord", {
      expeditionId: expedition.id,
      name: expedition.name,
      createdBy: user.id,
      guildId: interaction.guildId,
    });

  } catch (error) {
    logger.error("Error in expedition creation modal:", { error });
    await interaction.reply({
      content: `‚ùå Erreur lors de la cr√©ation de l'exp√©dition: ${error instanceof Error ? error.message : 'Erreur inconnue'}`,
      flags: ["Ephemeral"],
    });
  }
}

export async function handleExpeditionJoinCommand(interaction: ChatInputCommandInteraction) {
  const member = interaction.member as GuildMember;
  const user = interaction.user;

  try {
    // Get town info
    const townResponse = await apiService.getTownByGuildId(interaction.guildId!);
    if (!townResponse) {
      await interaction.reply({
        content: "‚ùå Aucune ville trouv√©e pour ce serveur.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Get user's active character
    const character = await getActiveCharacterForUser(interaction);
    if (!character) {
      await interaction.reply({
        content: "‚ùå Vous devez avoir un personnage actif pour rejoindre une exp√©dition.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Check if character is already on an expedition
    const activeExpeditions = await apiService.getActiveExpeditionsForCharacter(character.id);
    if (activeExpeditions && activeExpeditions.length > 0) {
      await interaction.reply({
        content: `‚ùå Votre personnage est d√©j√† sur une exp√©dition active: **${activeExpeditions[0].name}**.`,
        flags: ["Ephemeral"],
      });
      return;
    }

    // Get available expeditions (PLANNING status)
    const expeditions = await apiService.getExpeditionsByTown(townResponse.id);

    const availableExpeditions = expeditions.filter(exp => exp.status === "PLANNING");

    if (availableExpeditions.length === 0) {
      await interaction.reply({
        content: "‚ùå Aucune exp√©dition en cours de planification disponible.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Create dropdown menu
    const selectMenu = new StringSelectMenuBuilder()
      .setCustomId("expedition_join_select")
      .setPlaceholder("S√©lectionnez une exp√©dition √† rejoindre")
      .addOptions(
        availableExpeditions.map(exp => ({
          label: exp.name,
          description: `Stock: ${exp.foodStock}, Membres: ${exp.members.length}`,
          value: exp.id,
        }))
      );

    const row = new ActionRowBuilder<StringSelectMenuBuilder>().addComponents(selectMenu);

    await interaction.reply({
      content: "Choisissez une exp√©dition √† rejoindre:",
      components: [row],
      flags: ["Ephemeral"],
    });

  } catch (error) {
    logger.error("Error in expedition join command:", { error });
    await interaction.reply({
      content: "‚ùå Une erreur est survenue lors de la recherche des exp√©ditions.",
      flags: ["Ephemeral"],
    });
  }
}

export async function handleExpeditionJoinSelect(interaction: any) {
  const member = interaction.member as GuildMember;
  const user = interaction.user;
  const expeditionId = interaction.values[0];

  try {
    // Get user's active character
    const character = await getActiveCharacterForUser(interaction);
    if (!character) {
      await interaction.reply({
        content: "‚ùå Vous devez avoir un personnage actif pour rejoindre une exp√©dition.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Join expedition
    const memberData = await apiService.joinExpedition(expeditionId, character.id);

    await interaction.update({
      content: `‚úÖ Vous avez rejoint l'exp√©dition avec succ√®s!`,
      components: [],
    });

    logger.info("Character joined expedition via Discord", {
      expeditionId,
      characterId: character.id,
      joinedBy: user.id,
    });

  } catch (error) {
    logger.error("Error in expedition join select:", { error });
    await interaction.reply({
      content: `‚ùå Erreur lors de la participation √† l'exp√©dition: ${error instanceof Error ? error.message : 'Erreur inconnue'}`,
      flags: ["Ephemeral"],
    });
  }
}

export async function handleExpeditionInfoCommand(interaction: ChatInputCommandInteraction) {
  const member = interaction.member as GuildMember;
  const user = interaction.user;

  try {
    // Get user's active character
    const character = await getActiveCharacterForUser(interaction);
    if (!character) {
      await interaction.reply({
        content: "‚ùå Vous devez avoir un personnage actif pour voir les informations d'exp√©dition.",
        flags: ["Ephemeral"],
      });
      return;
    }

    // Get character's active expeditions
    const activeExpeditions = await apiService.getActiveExpeditionsForCharacter(character.id);

    if (!activeExpeditions || activeExpeditions.length === 0) {
      await interaction.reply({
        content: "‚ùå Votre personnage ne participe √† aucune exp√©dition active.",
        flags: ["Ephemeral"],
      });
      return;
    }

    const expedition = activeExpeditions[0];

    // Create embed
    const embed = new EmbedBuilder()
      .setColor(0x0099ff)
      .setTitle(`üöÄ ${expedition.name}`)
      .addFields(
        { name: "üì¶ Stock de nourriture", value: `${expedition.foodStock}`, inline: true },
        { name: "‚è±Ô∏è Dur√©e", value: `${expedition.duration}h`, inline: true },
        { name: "üìç Statut", value: getStatusEmoji(expedition.status), inline: true },
        { name: "üë• Membres", value: `${expedition.members.length}`, inline: true },
        { name: "üèõÔ∏è Ville", value: expedition.town.name, inline: true },
        { name: " ", value: " ", inline: true }
      )
      .setTimestamp();

    // Add buttons only if expedition is PLANNING and user is a member
    const components = [];
    if (expedition.status === "PLANNING") {
      const buttonRow = new ActionRowBuilder<ButtonBuilder>()
        .addComponents(
          new ButtonBuilder()
            .setCustomId("expedition_leave")
            .setLabel("Quitter")
            .setStyle(ButtonStyle.Danger),
          new ButtonBuilder()
            .setCustomId("expedition_transfer")
            .setLabel("Transf√©rer nourriture")
            .setStyle(ButtonStyle.Primary)
        );
      components.push(buttonRow);
    }

    await interaction.reply({
      embeds: [embed],
      components,
      flags: ["Ephemeral"],
    });

  } catch (error) {
    logger.error("Error in expedition info command:", { error });
    await interaction.reply({
      content: "‚ùå Une erreur est survenue lors de la r√©cup√©ration des informations d'exp√©dition.",
      flags: ["Ephemeral"],
    });
  }
}

function getStatusEmoji(status: string): string {
  switch (status) {
    case "PLANNING": return "üîÑ PLANIFICATION";
    case "LOCKED": return "üîí VERROUILL√âE";
    case "DEPARTED": return "‚úàÔ∏è PARTIE";
    case "RETURNED": return "üè† REVENUE";
    default: return status;
  }
}
