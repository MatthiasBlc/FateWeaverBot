# Backend Refactoring Plan - FateWeaverBot

## üìä Analyse Initiale

### Structure Actuelle

**Architecture:**
- Backend REST API (Express + TypeScript + Prisma)
- ~10,783 lignes de code TypeScript
- 51 fichiers source
- Structure MVC (Models via Prisma, Views = Routes, Controllers)

**Organisation des dossiers:**
```
backend/src/
‚îú‚îÄ‚îÄ controllers/      # 11 fichiers - Gestion des requ√™tes HTTP
‚îÇ   ‚îî‚îÄ‚îÄ admin/        # 2 fichiers - Controllers admin
‚îú‚îÄ‚îÄ cron/             # 6 fichiers - T√¢ches planifi√©es
‚îú‚îÄ‚îÄ interfaces/       # 1 fichier - DTOs
‚îú‚îÄ‚îÄ middleware/       # 1 fichier - Auth middleware
‚îú‚îÄ‚îÄ routes/           # 10 fichiers - D√©finition des routes
‚îÇ   ‚îî‚îÄ‚îÄ admin/
‚îú‚îÄ‚îÄ services/         # 10 fichiers - Logique m√©tier
‚îú‚îÄ‚îÄ types/            # 2 fichiers - Type definitions
‚îú‚îÄ‚îÄ util/             # 6 fichiers - Utilitaires
‚îú‚îÄ‚îÄ app.ts            # Configuration Express
‚îî‚îÄ‚îÄ server.ts         # Point d'entr√©e
```

### Fichiers les plus volumineux (complexit√© √©lev√©e)
1. `services/expedition.service.ts` - 1,326 lignes
2. `services/capability.service.ts` - 1,175 lignes
3. `controllers/characters.ts` - 941 lignes
4. `services/character.service.ts` - 672 lignes
5. `services/project.service.ts` - 444 lignes

### Points d'am√©lioration identifi√©s

#### üî¥ CRITIQUES
1. **Logging incoh√©rent** - 111 occurrences de console.log/error/warn
   - M√©lange de `console.log` et `logger` de Winston
   - Aucune structure de log uniforme
   - Difficile de filtrer/analyser les logs en production

2. **Duplication d'instance Prisma** - 33 fichiers importent Prisma
   - Chaque service cr√©e sa propre instance `new PrismaClient()`
   - Risque de connexions DB multiples
   - Violation du pattern Singleton
   - Incoh√©rence avec l'utilisation de `prisma` depuis `util/db.ts`

3. **Transactions Prisma non typ√©es/s√©curis√©es**
   - Nombreuses transactions complexes sans gestion d'erreur appropri√©e
   - Pas de retry logic pour les deadlocks
   - Pas de timeout configur√©

#### üü° IMPORTANTS
4. **Gestion d'erreurs non standardis√©e**
   - Mix de `throw createHttpError()`, `throw new Error()`, et `next(error)`
   - Pas de classe d'erreur custom pour les erreurs m√©tier
   - Messages d'erreur parfois en fran√ßais, parfois en anglais

5. **Validation des donn√©es incompl√®te**
   - Validation minimale dans les controllers
   - Pas d'utilisation de biblioth√®que de validation (Zod, Joi)
   - Risques de s√©curit√© et de bugs

6. **Services trop volumineux**
   - expedition.service.ts et capability.service.ts > 1000 lignes
   - Violation du principe de responsabilit√© unique
   - Difficiles √† maintenir et tester

7. **Pas de tests**
   - Aucun test unitaire ou d'int√©gration
   - Script de test par d√©faut dans package.json
   - Risque √©lev√© de r√©gression

#### üü¢ AM√âLIORATIONS
8. **Configuration dispers√©e**
   - Variables d'environnement dans validateEnv.ts
   - Constantes hardcod√©es dans le code
   - Pas de fichier de configuration centralis√©

9. **Types TypeScript √† am√©liorer**
   - Utilisation de `any` implicite dans certains endroits
   - Interfaces partiellement d√©finies
   - Pas d'utilisation de types d'utilit√© TS avanc√©s

10. **Documentation minimale**
    - Quelques commentaires JSDoc
    - Pas de documentation API (Swagger/OpenAPI)
    - TODOs non suivis (3 occurrences)

11. **Middleware d'authentification complexe**
    - auth.ts fait 214 lignes pour g√©rer IP/session
    - Logique CIDR dupliqu√©e
    - Logs excessifs en production

## üéØ Plan de Refactorisation (Phases)

### Phase 1: Infrastructure & Qualit√© de base (Priorit√© HAUTE)

#### 1.1 Standardiser le Logging
**Objectif:** Remplacer tous les console.* par le logger Winston

**T√¢ches:**
- [ ] Am√©liorer la configuration du logger dans `services/logger.ts`
  - Ajouter des niveaux de log configurables (debug, info, warn, error)
  - Configurer les transports (console, fichier, rotation)
  - Ajouter des m√©tadonn√©es contextuelles (service, userId, requestId)
- [ ] Cr√©er des helper functions de logging
  - `logInfo(message, context)`, `logError(error, context)`, etc.
- [ ] Remplacer tous les `console.log` par `logger.info`
- [ ] Remplacer tous les `console.error` par `logger.error`
- [ ] Remplacer tous les `console.warn` par `logger.warn`
- [ ] Ajouter un middleware de logging des requ√™tes HTTP structur√©

**Fichiers concern√©s:** 17 fichiers (111 occurrences)

**Impact:** üü¢ Faible risque - Pas de changement de logique m√©tier

#### 1.2 Corriger la gestion de Prisma Client
**Objectif:** Utiliser une seule instance Prisma partag√©e

**T√¢ches:**
- [ ] V√©rifier que `util/db.ts` exporte correctement l'instance singleton
- [ ] Remplacer toutes les `new PrismaClient()` par import depuis `util/db.ts`
- [ ] Ajouter des hooks Prisma pour logging des requ√™tes lentes
- [ ] Configurer le pool de connexions correctement
- [ ] Ajouter une gestion de d√©connexion propre (graceful shutdown)

**Fichiers concern√©s:** 10 services + controllers

**Impact:** üü° Risque moyen - Peut affecter les connexions DB

#### 1.3 Standardiser la gestion d'erreurs
**Objectif:** Approche coh√©rente des erreurs m√©tier et techniques

**T√¢ches:**
- [ ] Cr√©er des classes d'erreur custom (`errors/`)
  - `BusinessError` - Erreurs m√©tier (400)
  - `NotFoundError` - Ressources non trouv√©es (404)
  - `UnauthorizedError` - Auth required (401)
  - `ValidationError` - Donn√©es invalides (422)
- [ ] Cr√©er un middleware global d'erreur am√©lior√©
- [ ] Remplacer progressivement `throw createHttpError()` par classes custom
- [ ] Standardiser les messages d'erreur (anglais)
- [ ] Ajouter des codes d'erreur uniques pour faciliter le d√©bogage

**Fichiers concern√©s:** Tous les controllers et services

**Impact:** üü¢ Faible risque - Am√©lioration de la DX

### Phase 2: Architecture & Structure (Priorit√© MOYENNE)

#### 2.1 D√©couper les services volumineux
**Objectif:** Respecter le principe de responsabilit√© unique

**expedition.service.ts (1,326 lignes) ‚Üí Diviser en:**
- [ ] `expedition-lifecycle.service.ts` - Cr√©ation, lock, depart, return
- [ ] `expedition-navigation.service.ts` - Gestion des directions, path
- [ ] `expedition-members.service.ts` - Gestion des participants
- [ ] `expedition-events.service.ts` - √âv√©nements d'exp√©dition
- [ ] `expedition-emergency.service.ts` - Retours d'urgence

**capability.service.ts (1,175 lignes) ‚Üí Diviser en:**
- [ ] `capability-management.service.ts` - CRUD capacit√©s
- [ ] `capability-execution.service.ts` - Logique d'utilisation
- [ ] Cr√©er des services sp√©cifiques par type:
  - `hunting.service.ts`
  - `gathering.service.ts`
  - `fishing.service.ts`
  - `logging.service.ts`
  - `entertainment.service.ts`

**controllers/characters.ts (941 lignes) ‚Üí Diviser en:**
- [ ] `character.controller.ts` - CRUD de base
- [ ] `character-stats.controller.ts` - Gestion stats (PA, hunger, HP)
- [ ] `character-capabilities.controller.ts` - Gestion capacit√©s
- [ ] `character-lifecycle.controller.ts` - Kill, reroll, switch

**B√©n√©fices:**
- Code plus maintenable
- Tests unitaires plus faciles
- Meilleure s√©paration des responsabilit√©s
- R√©utilisabilit√© accrue

**Impact:** üü° Risque moyen - Refactoring majeur mais sans changement de logique

#### 2.2 Ajouter la validation des donn√©es
**Objectif:** S√©curiser et valider toutes les entr√©es

**T√¢ches:**
- [ ] Installer et configurer Zod
- [ ] Cr√©er des sch√©mas de validation pour chaque endpoint
  - `schemas/character.schema.ts`
  - `schemas/expedition.schema.ts`
  - `schemas/capability.schema.ts`
  - etc.
- [ ] Cr√©er un middleware de validation g√©n√©rique
- [ ] Appliquer la validation √† tous les endpoints
- [ ] Valider les variables d'environnement avec Zod (remplacer envalid)

**Fichiers concern√©s:** Tous les controllers + routes

**Impact:** üü¢ Faible risque - Ajout de s√©curit√©

#### 2.3 Refactorer le middleware d'authentification
**Objectif:** Simplifier et s√©curiser l'auth

**T√¢ches:**
- [ ] Extraire la logique CIDR dans `util/ip-utils.ts`
- [ ] Simplifier `requireInternal` et `requireAuthOrInternal`
- [ ] R√©duire le logging excessif (uniquement en mode debug)
- [ ] Ajouter des tests unitaires pour la logique IP
- [ ] Documenter les plages IP autoris√©es

**Fichiers concern√©s:** `middleware/auth.ts`

**Impact:** üü° Risque moyen - S√©curit√© critique

### Phase 3: Configuration & DevOps (Priorit√© MOYENNE)

#### 3.1 Centraliser la configuration
**Objectif:** Configuration claire et type-safe

**T√¢ches:**
- [ ] Cr√©er `config/index.ts` avec structure:
  ```typescript
  export const config = {
    server: { port, env, corsOrigin },
    database: { url, poolSize },
    session: { secret, maxAge },
    cron: { timezone, enableJobs },
    logging: { level, format }
  }
  ```
- [ ] Migrer depuis `validateEnv.ts`
- [ ] Ajouter des constantes m√©tier (PA regen, hunger levels, etc.)
- [ ] Cr√©er des fichiers .env.example complets

**Impact:** üü¢ Faible risque - Am√©lioration de la lisibilit√©

#### 3.2 Am√©liorer les types TypeScript
**Objectif:** Type-safety maximale

**T√¢ches:**
- [ ] √âliminer tous les `any` explicites et implicites
- [ ] Cr√©er des types d'utilit√© pour les r√©ponses API
- [ ] Typer correctement les middlewares Express
- [ ] Utiliser les types g√©n√©r√©s par Prisma partout
- [ ] Activer `strict: true` dans tsconfig (d√©j√† fait ‚úì)

**Impact:** üü¢ Faible risque - Am√©lioration de la DX

#### 3.3 Ajouter une documentation API
**Objectif:** Documentation auto-g√©n√©r√©e

**T√¢ches:**
- [ ] Installer Swagger/OpenAPI (swagger-ui-express)
- [ ] Ajouter des annotations JSDoc aux endpoints
- [ ] G√©n√©rer la documentation automatiquement
- [ ] Exposer `/api-docs` endpoint
- [ ] Documenter les schemas de validation Zod

**Impact:** üü¢ Faible risque - Am√©lioration de la DX

### Phase 4: Tests & Qualit√© (Priorit√© HAUTE - Long terme)

#### 4.1 Setup infrastructure de tests
**T√¢ches:**
- [ ] Installer Jest + ts-jest
- [ ] Configurer l'environnement de test
- [ ] Setup base de donn√©es de test (Prisma test DB)
- [ ] Cr√©er des fixtures et helpers de test

#### 4.2 Ajouter des tests
**Priorit√©:**
1. Services critiques (expedition, character, capability)
2. Middleware d'authentification
3. Validation des donn√©es
4. Controllers

**Objectif:** Au minimum 70% de couverture de code

**Impact:** üü¢ Faible risque - Ajout de s√©curit√©

### Phase 5: Performance & Optimisation (Priorit√© BASSE)

#### 5.1 Optimiser les requ√™tes Prisma
- [ ] Analyser les requ√™tes N+1
- [ ] Ajouter des index manquants
- [ ] Optimiser les includes/selects
- [ ] Impl√©menter du caching (Redis optionnel)

#### 5.2 Ajouter des transactions s√©curis√©es
- [ ] Ajouter retry logic pour deadlocks
- [ ] Configurer des timeouts
- [ ] Am√©liorer la gestion des erreurs de transaction

## üìã Ordre d'ex√©cution recommand√©

### Sprint 1 (1-2 semaines) - FONDATIONS
1. Phase 1.1 - Standardiser logging ‚úÖ CRITIQUE
2. Phase 1.2 - Corriger Prisma Client ‚úÖ CRITIQUE
3. Phase 3.1 - Centraliser configuration

### Sprint 2 (1-2 semaines) - S√âCURIT√â
4. Phase 1.3 - Standardiser erreurs
5. Phase 2.2 - Ajouter validation (Zod)
6. Phase 2.3 - Refactorer auth middleware

### Sprint 3 (2-3 semaines) - ARCHITECTURE
7. Phase 2.1 - D√©couper services volumineux
8. Phase 3.2 - Am√©liorer types TypeScript
9. Phase 3.3 - Documentation API

### Sprint 4+ (Continu) - QUALIT√â
10. Phase 4.1 - Setup tests
11. Phase 4.2 - √âcrire tests
12. Phase 5 - Optimisations

## üéì Principes directeurs

1. **Pas de breaking changes** - Maintenir la compatibilit√© API
2. **Refactoring incr√©mental** - Petit √† petit, feature par feature
3. **Tests en parall√®le** - √âcrire des tests pendant le refactoring
4. **Documentation continue** - Documenter au fur et √† mesure
5. **Review rigoureuse** - Chaque phase doit √™tre review√©e

## üìä M√©triques de succ√®s

- ‚úÖ Z√©ro `console.log` en production
- ‚úÖ Une seule instance Prisma
- ‚úÖ 100% des endpoints valid√©s
- ‚úÖ Couverture de tests > 70%
- ‚úÖ Documentation API compl√®te
- ‚úÖ Temps de r√©ponse API < 200ms (p95)
- ‚úÖ Z√©ro erreur TypeScript strict

## üîß Outils recommand√©s

- **Validation:** Zod
- **Tests:** Jest + ts-jest + supertest
- **Documentation:** Swagger/OpenAPI
- **Linting:** ESLint (d√©j√† pr√©sent)
- **Monitoring:** Winston + structured logging
- **Performance:** Prisma query logging

---

**Cr√©√© le:** 2025-10-16
**Version:** 1.0
**Statut:** üìù Plan initial - En attente d'approbation
